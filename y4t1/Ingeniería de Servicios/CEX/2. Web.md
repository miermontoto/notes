![[_resources/T2-Web.pdf]]
## Contenidos
1. Arquitectura básica
2. Sintaxis de los mensajes HTTP
3. Cabeceras HTTP
4. Proxies y cachés
5. Páginas generadas dinámicamente
6. Sesiones y cookies
7. Autenticación

#sockets #headers #cache #proxy

---
# 1. Arquitectura básica de la web

# 2. Sintaxis de los mensajes HTTP

# 3. Cabeceras HTTP
- El nombre no puede contener espacios y suelen estar estandarizados.
- `<CRLF>` es una forma de representar la secuencia de bytes `\r\n`.
- Las cabeceras terminan cuando aparece una línea en blanco `<CRLF><CRLF>`.

## Tipos de cabeceras
- **Generales**
	- `Date`
	- `Connection` (`keep-alive`, `close`): decide si cerrar el stream TCP o no.
	- `Cache-control`: decide si se aceptan contenidos cacheados o no.
- **De petición** (solo en msgs de petición)
	- `Host` (*obligatorio*): incluye el nombre de dominio al que se envía la petición.
	- `User-Agent`
	- `Accept`: tipos MIME que el cliente acepta.
	- `Accept-Encoding`: tipos de codificación que el cliente acepta.
	- `If-None-Match`: optimización que permite al cliente no descargar algo que ya tiene
	- `Cookie`
	- `Authroization`
- **De respuesta** (solo en msgs de respuesta)
	- `Server`
	- `WWW-Authenticate`: especifica tipo de autenticación
	- `Set-Cookie`
	- `Transfer-Encoding` (`chunked`): método usado por el servidor para enviar el cuerpo
- **De entidad**: describen el cuerpo.
	- `Content-Type`
	- `Content-Length`
	- `Content-Language`
	- `Etag`: identificador del recurso para optimizaciones de caché.
- **De extensión**: ampliaciones y otros usos no estandarizados.

# 4. Proxies y cachés
## Proxies
> [!info] Definición
> Servidores intermediarios entre el cliente y otros servidores.


## Tipos de proxies
### Directo
Sirve peticiones dirigidas a otros servidores.
![[_resources/Pasted image 20231002155428.png]]
### Indirecto
Ante el cliente parece un servidor normal, pero obtiene el recurso de otros servidores.
![[_resources/Pasted image 20231002155414.png]]
## Caché
> [!info] Definición
> Almacén más cercano y rápido que contiene copias de recursos para no tener que pedirlas de nuevo.

- Reducen el uso de red.
- Reducen el tiempo necesario para obtener el recurso.

**Códigos de respuesta**
- `304 Not Changed` (no se actualizó el contenido)
- `200 OK` (y envia una nueva copia)

### Estrategias (cabeceras)
Son diferentes estrategias para que el cliente sepa cuándo descargar un recurso otra vez.

#### Basado en la fecha de modificación
Se basa en la fecha del último cambio.
- El cliente solicita por primera vez un recurso.
- El servidor (tal vez) le devuelve en la cabecera `Last-Modified`
- El cliente almacena en su caché local el recurso, junto con esa fecha de última modificación.
- Cuando el cliente necesita el recurso de nuevo, usa el campo `If-Modified-Since` con la fecha guardada.

#### Basado en el cambio del contenido (etags)
Se basa en el contenido del recurso.

> [!info] ETag
> Es un hash del contenido del recurso.
> Si su recurso cambia, cambiará su ETag.

- Junto con el recurso, el servidor envía el hash en una cabecera `ETag`.
- El navegador almacena el hash junto al recurso.
- Cuando necesita de nuevo el recurso, usa la cabecera `If-None-Match` en la petición, con el valor del hash.

#### Basado en la fecha de caducidad (frescura)
Se basa en el tiempo estimado entre cambios.
- Junto con el recurso, el servidor envía un campo `Cache-control` donde especifica el tiempo de vida del recurso (`max-age`).
- El cliente no volverá a pedir el recurso hasta que expire el tiempo.

Esto evita el tráfico de 304 pero es un problema si el recurso cambia antes.

### Cache remota
- El cliente pide un recurso.
- Un proxy-caché intermedio gestiona la petición.
- Puede que el proxy devuelva una copia, en lugar de pedir el recurso.

### Control de la caché desde el HTML
Se puede indicar en el HTML que no se incluya en la caché el documento, tanto a los clientes como a proxies:
```HTML
<meta http-equiv="Cache-control" content="no-cache">
```

También existen los siguientes valores:
- `public` si puede almacenarse en proxies intermedios.
- `private` si puede almacenarse en el cliente.
- `max-age=X` si puede almacenarse, pero caduca.

# 5. Páginas generadas dinámicamente
Son el resultado de ejecutar un programa externo cuya salida depende de los parámetros que se le pasen los cuales se obtienen de al URL o de los datos suministrados vía POST.

**Tecnologías para contenido dinámico**
- CGI (*Common Gateway Interface*)
- Módulos en el servidor web
- Fast CGI, SCGI
- ASP.NET
- Tecnologías Java

## CGI
- La tecnología más antigua y simple.
- El código no se ejecuta en el servidor web, sino en un proceso externo (lanzado con `fork()`) al que se le pasan variables de entorno los parámetros apropiados.
- La salida estandar de ese proceso es lo que el servidor devuelve como respuesta.

> [!error] La sobrecarga de crear un proceso nuevo por cada petición lo hace inaceptable y ha quedado obsoleto :)

## Módulos en el servidor web
- EL servidor web incluye <u>intérpretes</u> de ciertos lenguajes, por lo que el código se ejecuta como parte del proceso servidor-web.
- Es un método muy común en Apache (ej: `mod_php`)
- El mismo servidor sirve contenidos estáticos y dinámicos.

> [!warning] No permite tener máquinas separadas y optimizadas a cada caso (estático/dinámico)


## FastCGI, SCGI
- Además del servidor Web, existe otro servidor de "aplicaciones"
- Ambos se comunican entre sí por sockets.
- Se pasan parámetros y resultados con un protocolo específico binario.
- El servidor de aplicación puede estar escrito en cualquier lenguaje.

# 6. Sesiones y cookies
## Sesiones
> [!info] Definición
> Una sesión es un conjunto de peticiones HTTP que tienen como denominador común el estar dirigidas a un mismo servidor, desde un mismo usuario.
### Token de sesión HTTP
Identificador único para cada sesión.
- Generado por el servidor en la primera interacción con el cliente para esa sesión.
- El cliente lo debe proporcionar de nuevo al servidor en cada interacción de esa sesión.

> [!info] Gracias al token, el servidor "reconoce" al cliente y puede acceder al estado del cliente, típicamente almacenado en una base de datos.

**Mecanismos del transmisión del token**
- En la url de los métodos HTTP (raro)
- En cookies (habitual)

## Cookies
> [!info] Definición
> Información (cadena de texto) que el servidor envía al cliente a través de la cabecera `Set-Cookie`.

Se espera que el cliente:
- Almacene esa información asociada con el servidor que la envió.
- La envíe en cada una de las peticioens que vuelva a hacerle a ese servidor, a través de otra cabecera `Cookie`.

#### Sintaxis
```Response
Set-Cookie: nombre=valor; atributos
```

- **nombre:** cualquier identificador alfanumérico.
- **valor:** cualquier secuencia de caracteres (salvo punto y coma). No significa nada para el cliente.
- **atributos:** parejas clave/valor que definen aspectos de la cookie, como el servidor, la caducidad...
- Si el servidor quiere enviar varias cookies, puede poner varios `Set-Cookie`.

 El cliente puede devolver varias cookies en el mismo campo.

#### Usos
- Identificación de la sesión
- Personalización
- Segumiento (estadísticas)

#### Tipos
- **Cookies de sesión**
	- No deben especificar su caducidad
	- El navegador debe borrarlas al cerrar
	- Típicamente almacenan un *token de sesión*.
- **Cookies persistentes**
	- Especifican caducidad
	- Se almacenan en disco (no en RAM)
	- Almacenan preferencias
- **Cookies de terceros**
	- Se envían a servidores distintos del que aparece en la barra de navegación del navegador.


# 7. Autenticación