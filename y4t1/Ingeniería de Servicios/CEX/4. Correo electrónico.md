![[_resources/T4-email.pdf]]

---

# Introducción
**Servicio:** envío de mensajes de texto (posteriormente, cualquier tipo de fichero) a otro usuario en otra máquina, de forma asíncrona.

## Entidades
- Remitente
- Desintatario
- **MUA** *Message User Agent*: el programa que usa el remitente para enviar, y el destinatario para recibir.
	- ej: outlook, interfaces web, thunderbird...
- **MTA** *Message Transfer Agent*: el programa que recibe el mensaje del MUA del remitente y lo transmite a otro MTA en una máquina a la que el destinartario tiene acceso.
	- microsoft exchange, sendmail, qmail, postfix...
- Buzón

## Arquitectura
![[_resources/Pasted image 20231031162532.png]]

# Cabeceras
- `From`: remitente
- `To`: destino
- `Reply-To`: quién debe recibir la respuesta
- `Cc`: carbon copy
- `Bcc`: blind carbon copy
- `Subject`
- `Date`
- `Message-Id`

Otras son añadidas por los MTA por donde pasa el mensaje:
- `Date`, `From`, `To`, `Message-Id` suelen ser añadidas por el primer MTA.
- `Received`: añadida por cada MTA atravesado por el mensaje, registra qué MTA lo recibe, de dónde procede y la fecha y hora.
- `Return-path`: añadida por el MTA destino.

# MIME
> [!warning] RELLENAR
> simplemente no me salió de los cojones

# SMTP
Protocolo para mensajes entre buzones.

- Va sobre TCP
- El cliente puede ir autenticado o no
- Dos usos diferentes:
	1. Entre un MUA y un MTA (normalmente con autenticación)
	2. Entre dos MTA (normalmente sin cifrado)

## Características
- Orientado a mensajes de texto (HTTP)
	- **Petición:** comando + parámetros
	- **Respuesta:** código + descripción textual
	- **Terminador de línea:** CRLF
- Algunas peticiones pueden requerir más líneas después de la que lleva el comando
- Algunas respuestas también pueden ser varias líneas

## Comandos
![[_resources/Pasted image 20231108181242.png]]

El mensaje que sigue a `DATA` contiene las cabeceras (con terminación) y el cuerpo. Se considera finalizado al recibir una línea que contiene tan solo un punto (terminador = `\r\n.\r\n`)

## Respuestas
> [!success] "No necesitáis saberlos"

## Ejemplo de diálogo típico
*Tras establecer conexión TCP (puerto 25)*

![[_resources/Pasted image 20231108182407.png]]

## Envelope
Para transportar el mensaje a su destino (y poder devolverlo), el protocolo debe conocer:
- El destino (comando `RCPT TO:`)
- El origen (comando `MAIL FROM:`)
Esta información *no forma parte del mensaje* (tampoco son las cabeceras), pero viaja con él. **Esto es el envelope.**

Sin embargo, en las cabeceras del mensaje también hay un campo `From` y otro `To`.

### Problemas de seguridad
- El cliente puede usar el servidor SMTP de otro dominio.
- El cliente puede mentir en el `HELO` y poner un nombre falso, aunque el servidor conoce su IP a través del socket.
- El cliente puede poner un `FROM` diferente en el comando `MAIL` del que luego va en el campo `From:`. El destinatario final verá las del mensaje.
- El cliente puede poner un `FROM` de un usuario que no existe en su dominio. El servidor no conoce usuarios. Cuando el remitente intenten responder al correo lo hará a una dirección inexistente.
- El cliente puede poner un `FROM` completamente falso de otro usuario desde otro dominio, el protocolo no lo impide. Esto permite enviar correo en nombre de otra persona.

### Soluciones
- **SPF**: mecanismo que el servidor puede usar para decidir si admite el remite proporcionado en `MAIL FROM` o lo rechaza. Lo acepta si:
	- El dominio del remite tiene una entrada en el DNS.
	- Esa entrada tiene un campo `TXT` que lista una serie de IPs permitidas.
	- La IP del cliente está en esa lista.
- **SMTP-AUTH:** extensión de SMTP que permite autenticar el remitente con nombre y clave (entre otros métodos).

## Extensiones
El protocolo básico se ha extendido para soportar autenticación, cifrado, etc.

Un cliente puede consultar qué extensiones tiene un servidor si usa `EHLO` en lugar de `HELO`.

**Extensiones importantes**
- **Transporte cifrado:** si el servidor lo soporta, el cliente puede enviar el  `STARTTLS` y el envolver del socket de comunicación con una biblioteca SSL. El resto de comandos y respuestas irán sobre el transporte cifrado.
- **Autenticación del cliente:** el cliente puede usar el comando `AUTH <método>` para autenticarse usando el método en cuestión. Posibles métodos:
	- `LOGIN`: las dos líneas siguientes envían nombre y clave respectivamente, codificadas en Base64.
	- `PLAIN`: en la línea siguiente va nombre y clave sin codificar, terminadas con ASCII nulo.
	- Otros: CRAM-MD5, OAuth, OAuth2, ...

### Ejemplo de diálogo con servidor extendido
![[_resources/Pasted image 20231108184450.png]]

***A partir de este punto, el diálogo va cifrado sobre SSL.***

![[_resources/Pasted image 20231108184826.png]]


# POP3
Protocolo para leer mensajes de un buzón.

**Funcionalidad básica:**
- Conectarse al MTA que tiene el buzón de mensajes
- Consultar cuántos mensajes hay en el buzón
- Descargar mensajes seleccionados
- Borrar mensajes del buzón

- Protocolo de tipo comando/respuesta, similar a SMTP en sintaxis.
- Puerto estándar 110.
- Estados:
	- Autorización
	- Transacción
	- Actualización

> [!warning] El resto no es muy relevante.




